// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id Int @id @default(autoincrement())

  evmAddress Bytes @unique

  OnChainEnergyPurchases OnChainEnergyPurchase[]
  Stories                Story[] // Stories the user is participating in
  Content                StoryContent[] // User-generated content
}

model OnChainEnergyPurchase {
  blockNumber Int
  logIndex    Int

  txHash    Bytes
  blockTime DateTime

  userId Int
  energy Int
  value  Bytes // In native token

  User User @relation(fields: [userId], references: [id])

  @@id([blockNumber, logIndex])
}

model Character {
  id Int @id @default(autoincrement())

  // TODO: Rename to avatarUrl
  imagePreviewUrl String

  name  String // E.g. "Spot"
  // TODO: Remove title
  title String // E.g. "The all-seeing dog"
  about String // Short description

  personality String // Used in a prompt, should be hidden from the user

  erc1155Address Bytes?
  erc1155Id      Bytes?
  erc1155NftUri  String?

  Stories  Story[] // Stories the character is participating in
  Memories StoryMemory[] // Memories of the character
  Content  StoryContent[] // Content created by the character (user-controlled or not)
}

model Story {
  id Int @id @default(autoincrement())

  charIds    Int[] // All characters in the story (including user-controlled ones)
  userIds    Int[] // Real users acting in the story
  userMap    String // JSON mapping from a user ID to their character ID
  nextCharId Int // Id of the next character to act

  name   String? // Display name of the story
  setup  String? // The initial setup of the story, present in all prompts
  fabula String? // The initial context of the story, augmented by memories
  buffer Int[]   @default([]) // Recent content buffer

  busy Boolean // Is the story generation in progress?
  pid  Bytes?  @unique // Process responsible for the generation

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  Users      User[]
  Characters Character[]
  Content    StoryContent[]
  Memories   StoryMemory[]
}

model StoryContent {
  id Int @id @default(autoincrement())

  storyId Int
  charId  Int
  userId  Int? // If null, the content is generated by the system

  energyCost Int
  content    String? // Content generation may be in progress
  createdAt  DateTime @default(now())

  Story       Story         @relation(fields: [storyId], references: [id])
  Character   Character     @relation(fields: [charId], references: [id])
  User        User?         @relation(fields: [userId], references: [id])
  Checkpoints StoryMemory[]
}

// A story memory per (character) actor.
// Not saved for a user-controlled character.
model StoryMemory {
  storyId Int
  charId  Int

  checkpoint Int
  memory     String

  Story      Story        @relation(fields: [storyId], references: [id])
  Character  Character    @relation(fields: [charId], references: [id])
  Checkpoint StoryContent @relation(fields: [checkpoint], references: [id])

  @@id([storyId, charId])
}
